<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personal Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(120deg, #e0f7fa 0%, #f8fafc 60%, #e6f4f1 100%);
      }
      .bg-blur {
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
      }
    </style>
  </head>
  <body class="min-h-screen bg-blur">
    <!-- AUTHENTICATION CHECK - NO BYPASSING ALLOWED -->
    <script>
      // Immediate auth check - redirect if not logged in
      (function() {
        const isAuthenticated = localStorage.getItem('isAuthenticated');
        const userEmail = localStorage.getItem('userEmail');
        
        if (!isAuthenticated || !userEmail) {
          console.log('❌ Unauthorized access attempt, redirecting to auth');
          window.location.href = 'auth.html';
          return;
        }
        console.log('✅ User authenticated:', userEmail);
      })();
    </script>
    
    <a href="profile.html" class="fixed top-4 left-4 z-20 flex items-center text-gray-400 hover:text-black focus:outline-none focus:ring-2 focus:ring-gray-300 transition" style="background: none; box-shadow: none; padding: 0;">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </a>
    <main class="max-w-md mx-auto pt-10 pb-12 px-4 flex flex-col items-center">
      <h2 class="text-xl font-semibold text-gray-900 mb-6">Personal Details</h2>
      
      <!-- Required Fields Note -->
      <div class="w-full bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div class="text-sm text-blue-800">
            <p class="font-medium mb-1">Required for Health Insights</p>
            <p>Date of Birth and Biological Sex are required to provide accurate respiratory health assessments using our AI model.</p>
          </div>
        </div>
      </div>
      
      <form id="personal-details-form" class="w-full bg-white rounded-2xl shadow p-6 space-y-5">
        <div>
          <label class="block text-gray-400 text-sm mb-1" for="fullName">Full Name</label>
          <input id="fullName" name="fullName" type="text" class="w-full border border-gray-200 rounded-xl px-4 py-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#199A8E] focus:border-[#199A8E] bg-white shadow-sm transition-all duration-200 placeholder-gray-400" placeholder="Enter your name" />
        </div>

        <div>
          <label class="block text-blue-600 text-sm mb-1 font-medium" for="dob">Date of Birth *</label>
          <input id="dob" name="dob" type="date" class="w-full border border-blue-200 rounded-xl px-4 py-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm transition-all duration-200" required />
        </div>
        <div>
          <label class="block text-blue-600 text-sm mb-1 font-medium" for="sex">
            <span class="cursor-pointer hover:text-blue-700 transition-colors duration-200" id="sex-label-highlight">Biological Sex</span> *
          </label>
          <div class="relative">
            <div class="flex border border-blue-200 rounded-lg overflow-hidden bg-white/70">
              <button type="button" id="sex-female" class="sex-option flex-1 px-4 py-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#199A8E] focus:ring-inset transition-all duration-200 border-r border-blue-200 hover:bg-gray-50" data-value="female">
                <div class="flex items-center justify-center gap-2">
                  <svg class="w-4 h-4 text-gray-400 transition-colors duration-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  <span class="font-medium">Female</span>
                </div>
              </button>
              <button type="button" id="sex-male" class="sex-option flex-1 px-4 py-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#199A8E] focus:ring-inset transition-all duration-200 hover:bg-gray-50" data-value="male">
                <div class="flex items-center justify-center gap-2">
                  <svg class="w-4 h-4 text-gray-400 transition-colors duration-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  <span class="font-medium">Male</span>
                </div>
              </button>
            </div>
            <input type="hidden" id="sex" name="sex" required />
          </div>
        </div>
        <!-- Height Field with Unit Selection -->
        <div>
          <label class="block text-gray-400 text-sm mb-1" for="height">Height</label>
          <div class="flex gap-2">
            <input id="height" name="height" type="number" min="0" step="0.1" class="flex-1 border border-gray-200 rounded-xl px-4 py-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#199A8E] focus:border-[#199A8E] bg-white shadow-sm transition-all duration-200 placeholder-gray-400" placeholder="Enter height" />
            <select id="heightUnit" name="heightUnit" class="w-24 border border-gray-200 rounded-xl px-3 py-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#199A8E] focus:border-[#199A8E] bg-white shadow-sm transition-all duration-200">
              <option value="cm">cm</option>
              <option value="ft">ft</option>
            </select>
          </div>
          <div id="heightConversion" class="text-xs text-[#199A8E] mt-2 ml-1 hidden font-medium"></div>
        </div>

        <!-- Weight Field with Unit Selection -->
        <div>
          <label class="block text-gray-400 text-sm mb-1" for="weight">Weight</label>
          <div class="flex gap-2">
            <input id="weight" name="weight" type="number" min="0" step="0.1" class="flex-1 border border-gray-200 rounded-xl px-4 py-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#199A8E] focus:border-[#199A8E] bg-white shadow-sm transition-all duration-200 placeholder-gray-400" placeholder="Enter weight" />
            <select id="weightUnit" name="weightUnit" class="w-24 border border-gray-200 rounded-xl px-3 py-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#199A8E] focus:border-[#199A8E] bg-white shadow-sm transition-all duration-200">
              <option value="kg">kg</option>
              <option value="lbs">lbs</option>
            </select>
          </div>
          <div id="weightConversion" class="text-xs text-[#199A8E] mt-2 ml-1 hidden font-medium"></div>
        </div>
        <div>
          <label class="block text-gray-400 text-sm mb-1" for="bloodType">Blood Type</label>
          <select id="bloodType" name="bloodType" class="w-full border border-gray-200 rounded-xl px-4 py-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#199A8E] focus:border-[#199A8E] bg-white shadow-sm transition-all duration-200">
            <option value="" disabled selected>Select blood type</option>
            <option value="A+">A+</option>
            <option value="A-">A-</option>
            <option value="B+">B+</option>
            <option value="B-">B-</option>
            <option value="AB+">AB+</option>
            <option value="AB-">AB-</option>
            <option value="O+">O+</option>
            <option value="O-">O-</option>
          </select>
        </div>
        <button type="submit" class="w-full bg-[#199A8E] hover:bg-[#157c71] text-white font-medium rounded-xl py-3 text-base text-center shadow transition mt-2">Save</button>
      </form>
    </main>

    <!-- Biological Sex Info Modal -->
    <div id="sex-info-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Why Biological Sex Matters</h3>
            <button id="close-sex-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          
          <div class="space-y-4">
            <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
              <h4 class="font-medium text-blue-900 mb-2">AI Model Accuracy</h4>
              <p class="text-sm text-blue-800">Our machine learning model uses biological sex data to provide more accurate respiratory health assessments by considering physiological differences between males and females.</p>
            </div>
            
            <div class="space-y-3">
              <div class="flex items-start gap-3">
                <div class="w-2 h-2 bg-[#199A8E] rounded-full mt-2 flex-shrink-0"></div>
                <div>
                  <h5 class="font-medium text-gray-900 text-sm">Lung Function Differences</h5>
                  <p class="text-xs text-gray-600">Males typically have larger lung capacity, while females may be more sensitive to certain respiratory irritants</p>
                </div>
              </div>
              
              <div class="flex items-start gap-3">
                <div class="w-2 h-2 bg-[#199A8E] rounded-full mt-2 flex-shrink-0"></div>
                <div>
                  <h5 class="font-medium text-gray-900 text-sm">Disease Risk Patterns</h5>
                  <p class="text-xs text-gray-600">Asthma is more common in females, while COPD is more prevalent in males</p>
                </div>
              </div>
              
              <div class="flex items-start gap-3">
                <div class="w-2 h-2 bg-[#199A8E] rounded-full mt-2 flex-shrink-0"></div>
                <div>
                  <h5 class="font-medium text-gray-900 text-sm">Symptom Presentation</h5>
                  <p class="text-xs text-gray-600">Respiratory symptoms can manifest differently between sexes</p>
                </div>
              </div>
              
              <div class="flex items-start gap-3">
                <div class="w-2 h-2 bg-[#199A8E] rounded-full mt-2 flex-shrink-0"></div>
                <div>
                  <h5 class="font-medium text-gray-900 text-sm">Treatment Response</h5>
                  <p class="text-xs text-gray-600">Medication effectiveness and side effects vary by biological sex</p>
                </div>
              </div>
            </div>
            
            <div class="bg-[#e6f4f1] rounded-xl p-4 border border-[#199A8E]/20">
              <p class="text-sm text-[#199A8E] font-medium text-center">
                💡 This information helps our AI provide personalized, accurate health insights tailored to your specific physiology.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Pre-fill form if data exists
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('personal-details-form');
        const saved = localStorage.getItem('personalDetails');
        if (saved) {
          const data = JSON.parse(saved);
          if (data.fullName) form.fullName.value = data.fullName;
          if (data.dob) form.dob.value = data.dob;
          if (data.sex) form.sex.value = data.sex;
          if (data.height) form.height.value = data.height;
          if (data.heightUnit) form.heightUnit.value = data.heightUnit;
          if (data.weight) form.weight.value = data.weight;
          if (data.weightUnit) form.weightUnit.value = data.weightUnit;
          if (data.bloodType) form.bloodType.value = data.bloodType;
        }
        
        // Set up biological sex button functionality
        setupSexButtons();
        
        // Set up biological sex label click functionality
        setupSexLabelClick();
        
        // Set up measurement unit conversion
        setupMeasurementConversion();
        

        form.onsubmit = function(e) {
          e.preventDefault();
          
          // Validate required fields for ML model
          if (!form.dob.value || !form.sex.value) {
            alert('Date of Birth and Biological Sex are required for accurate health insights.');
            return;
          }
          
          const data = {
            fullName: form.fullName.value,
            dob: form.dob.value,
            sex: form.sex.value,
            height: form.height.value,
            heightUnit: form.heightUnit.value,
            weight: form.weight.value,
            weightUnit: form.weightUnit.value,
            bloodType: form.bloodType.value
          };
          
          localStorage.setItem('personalDetails', JSON.stringify(data));
          
          // Save user-specific data for future sign-ins
          const userEmail = localStorage.getItem('userEmail');
          if (userEmail) {
            const userData = {
              fullName: data.fullName,
              personalDetails: data
            };
            localStorage.setItem(`user_${userEmail}`, JSON.stringify({
              email: userEmail,
              lastUpdated: new Date().toISOString(),
              ...userData
            }));
          }
          
          // Check if user came from self-diagnosis
          const urlParams = new URLSearchParams(window.location.search);
          const redirectTo = urlParams.get('redirect');
          
          if (redirectTo === 'selfdiagnosis') {
            window.location.href = 'selfdiagnosis.html?start=1';
          } else {
            window.location.href = 'profile.html';
          }
        };
      });
      
      // Function to set up biological sex button functionality
      function setupSexButtons() {
        const sexButtons = document.querySelectorAll('.sex-option');
        const hiddenSexInput = document.getElementById('sex');
        
        sexButtons.forEach(button => {
          button.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            
            // Update hidden input
            hiddenSexInput.value = value;
            
            // Update visual state of all buttons
            updateSexButtonState(value);
          });
        });
      }
      
      // Function to update the visual state of sex buttons
      function updateSexButtonState(selectedValue) {
        const sexButtons = document.querySelectorAll('.sex-option');
        
        sexButtons.forEach(button => {
          const value = button.getAttribute('data-value');
          const icon = button.querySelector('svg');
          const text = button.querySelector('span');
          
          if (value === selectedValue) {
            // Selected state
            button.classList.remove('text-gray-900', 'bg-white/70');
            button.classList.add('text-[#199A8E]', 'bg-[#e6f4f1]');
            icon.classList.remove('text-gray-400');
            icon.classList.add('text-[#199A8E]');
            text.classList.remove('text-gray-900');
            text.classList.add('text-[#199A8E]', 'font-semibold');
            icon.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>';
          } else {
            // Unselected state
            button.classList.remove('text-[#199A8E]', 'bg-[#e6f4f1]');
            button.classList.add('text-gray-900', 'bg-white/70');
            icon.classList.remove('text-[#199A8E]');
            icon.classList.add('text-gray-400');
            text.classList.remove('text-[#199A8E]', 'font-semibold');
            text.classList.add('text-gray-900', 'font-medium');
            icon.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>';
          }
        });
      }
      
      // Function to set up biological sex label click functionality
      function setupSexLabelClick() {
        const sexLabel = document.getElementById('sex-label-highlight');
        const modal = document.getElementById('sex-info-modal');
        const closeButton = document.getElementById('close-sex-modal');
        
        // Open modal when label is clicked
        sexLabel.addEventListener('click', function() {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
        });
        
        // Close modal when close button is clicked
        closeButton.addEventListener('click', function() {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto'; // Restore scrolling
        });
        
        // Close modal when clicking outside
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
          }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
          }
        });
      }

      // Function to set up measurement unit conversion
      function setupMeasurementConversion() {
        const heightInput = document.getElementById('height');
        const heightUnit = document.getElementById('heightUnit');
        const heightConversion = document.getElementById('heightConversion');
        
        const weightInput = document.getElementById('weight');
        const weightUnit = document.getElementById('weightUnit');
        const weightConversion = document.getElementById('weightConversion');
        
        // Height conversion
        function updateHeightConversion() {
          const value = parseFloat(heightInput.value);
          if (!value || value <= 0) {
            heightConversion.classList.add('hidden');
            return;
          }
          
          const unit = heightUnit.value;
          let convertedValue, convertedUnit, convertedText;
          
          if (unit === 'cm') {
            // Convert cm to feet and inches
            const totalInches = value / 2.54;
            const feet = Math.floor(totalInches / 12);
            const inches = Math.round((totalInches % 12) * 10) / 10;
            convertedText = `${feet}'${inches}"`;
            convertedValue = `${feet} ft ${inches} in`;
          } else {
            // Convert feet to cm
            convertedValue = Math.round(value * 30.48);
            convertedText = `${convertedValue} cm`;
          }
          
          heightConversion.textContent = `≈ ${convertedText}`;
          heightConversion.classList.remove('hidden');
        }
        
        // Weight conversion
        function updateWeightConversion() {
          const value = parseFloat(weightInput.value);
          if (!value || value <= 0) {
            weightConversion.classList.add('hidden');
            return;
          }
          
          const unit = weightUnit.value;
          let convertedValue, convertedText;
          
          if (unit === 'kg') {
            // Convert kg to lbs
            convertedValue = Math.round(value * 2.205 * 10) / 10;
            convertedText = `${convertedValue} lbs`;
          } else {
            // Convert lbs to kg
            convertedValue = Math.round(value / 2.205 * 10) / 10;
            convertedText = `${convertedValue} kg`;
          }
          
          weightConversion.textContent = `≈ ${convertedText}`;
          weightConversion.classList.remove('hidden');
        }
        
        // Add event listeners
        heightInput.addEventListener('input', updateHeightConversion);
        heightUnit.addEventListener('change', updateHeightConversion);
        
        weightInput.addEventListener('input', updateWeightConversion);
        weightUnit.addEventListener('change', updateWeightConversion);
        
        // Set default units based on user preference or locale
        setDefaultUnits();
      }
      
      // Function to set default units based on user preference
      function setDefaultUnits() {
        // Check if user has previously set units
        const saved = localStorage.getItem('personalDetails');
        if (saved) {
          const data = JSON.parse(saved);
          if (data.heightUnit) {
            document.getElementById('heightUnit').value = data.heightUnit;
          }
          if (data.weightUnit) {
            document.getElementById('weightUnit').value = data.weightUnit;
          }
          return;
        }
        
        // Set default units based on locale (US uses imperial, others use metric)
        const isUS = Intl.DateTimeFormat().resolvedOptions().timeZone.includes('America');
        
        if (isUS) {
          document.getElementById('heightUnit').value = 'ft';
          document.getElementById('weightUnit').value = 'lbs';
        } else {
          document.getElementById('heightUnit').value = 'cm';
          document.getElementById('weightUnit').value = 'kg';
        }
      }

    </script>
  </body>
</html> 