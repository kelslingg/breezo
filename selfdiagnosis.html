<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Self-Diagnosis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(120deg, #d0f2f6 0%, #f0f4fa 60%, #cceee7 100%);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
      }
    </style>
  </head>
  <body class="min-h-screen bg-blur">
    <div class="w-full text-center pt-8 pb-2">
      <span class="text-2xl md:text-3xl font-normal text-[#199A8E] tracking-tight">Self-Diagnosis</span>
              <div class="w-full flex flex-col items-center mt-2 mb-2">
          <div class="w-full max-w-xl h-2 bg-gray-200 rounded-full overflow-hidden mb-2">
            <div class="h-2 bg-[#199A8E] rounded-full transition-all duration-300" id="progress-bar" style="width: 25%;"></div>
          </div>
          <div class="text-gray-600 text-sm mb-2" id="step-indicator">Step 1: Personal Information</div>
          <div class="text-red-500 text-sm max-w-xl mx-auto text-center">This is not a medical diagnosis. Always consult a healthcare provider for confirmation.</div>
        </div>
    </div>
    <a href="index.html" class="fixed top-4 left-4 z-20 flex items-center text-gray-400 hover:text-black focus:outline-none focus:ring-2 focus:ring-gray-300 transition" style="background: none; box-shadow: none; padding: 0;">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </a>
    <main id="input-main" class="max-w-xl mx-auto flex flex-1 flex-col justify-center items-center min-h-[80vh] px-4">
              <div class="w-full max-w-md mx-auto flex flex-col items-center justify-center gap-6">
          <div class="w-full bg-white rounded-2xl shadow p-6 flex flex-col gap-4">

            
            <!-- Search Bar -->
          <div class="w-full flex flex-col items-center mb-6 !bg-transparent !border-0 !shadow-none" id="symptom-search-container" style="background: none; box-shadow: none; border: none;">
            <div class="relative w-full max-w-xl !bg-transparent !border-0 !shadow-none" style="background: none; box-shadow: none; border: none;">
              <span class="absolute left-4 top-1/2 -translate-y-1/2 flex items-center">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
              </span>
              <input id="symptom-input" type="text" autocomplete="off" placeholder="Start typing a symptom..." class="w-full pl-10 pr-4 py-3 bg-white/80 border border-gray-300 rounded-xl text-gray-900 text-base focus:outline-none focus:ring-2 focus:ring-[#199A8E] placeholder-gray-400 shadow-sm" />
            </div>
            <div id="selected-symptoms" class="hidden"></div>
          </div>
          <!-- Suggested Symptoms List -->
          <div class="w-full flex flex-col items-center mb-2 !bg-transparent !border-0 !shadow-none" style="background: none; box-shadow: none; border: none;">
            <div class="text-gray-400 text-base mb-2 w-full max-w-xl !bg-transparent" style="background: none;">Suggested symptoms</div>
            <div class="text-gray-300 text-sm mb-3 w-full max-w-xl !bg-transparent text-center" style="background: none;">Some symptoms have follow-up questions for more accurate results</div>
            <div id="suggested-symptoms-list" class="w-full max-w-xl flex flex-col gap-1 !bg-transparent !border-0 !shadow-none" style="background: none; border: none; box-shadow: none;"></div>
          </div>
        </div>
      </div>
    </main>
    <div id="followup-fullscreen" class="fixed inset-0 z-[9999] flex items-center justify-center bg-gradient-to-br from-blue-50 via-purple-100 to-white/90 backdrop-blur-xl hidden">
      <div class="w-full h-full flex flex-col items-center justify-center pt-8 relative">
        <button id="close-followup" class="absolute top-6 left-6 w-10 h-10 flex items-center justify-center rounded-full bg-[#f1f5f9] text-gray-400 hover:bg-[#e2e8f0] focus:outline-none transition z-10" aria-label="Back">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div id="followup-question" class="text-lg md:text-xl font-medium text-gray-700 text-center mb-10 px-4 flex items-center justify-center w-full max-w-2xl" style="min-height:4rem;"></div>
        <div id="followup-options" class="flex gap-8 flex-wrap justify-center max-w-4xl px-4"></div>
      </div>
    </div>
    <div id="review-screen" class="fixed inset-0 z-50 flex items-start justify-center bg-gradient-to-br from-blue-100 via-white to-blue-200 backdrop-blur-2xl hidden">
      <div class="w-full h-full flex flex-col items-center px-4 pt-0">
        <!-- Top Section (copied from input screen for perfect match) -->
        <div class="w-full text-center pt-8 pb-2 relative">
          <button id="close-review" class="absolute top-0 left-0 z-20 flex items-center text-gray-400 hover:text-black focus:outline-none focus:ring-2 focus:ring-gray-300 transition bg-none shadow-none p-0" style="background: none; box-shadow: none; padding: 0;">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <span class="text-2xl md:text-3xl font-normal text-[#199A8E] tracking-tight">Self-Diagnosis</span>
          <div class="w-full flex flex-col items-center mt-2 mb-2">
            <div class="w-full max-w-xl h-2 bg-gray-200 rounded-full overflow-hidden mb-2">
              <div class="h-2 bg-[#199A8E] rounded-full transition-all duration-300" style="width: 100%;"></div>
            </div>
            <div class="text-red-500 text-sm max-w-xl mx-auto text-center">This is not a medical diagnosis. Always consult a healthcare provider for confirmation.</div>
          </div>
        </div>
        <!-- Checkmark and Review -->
        <div class="flex flex-col items-center w-full max-w-xl mx-auto">
          <div class="rounded-full bg-[#e6f4f1] w-24 h-24 flex items-center justify-center mb-4 mt-2">
            <svg class="w-14 h-14 text-[#199A8E]" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div class="text-2xl font-bold text-gray-900 mb-1" id="review-symptom-count"></div>
          <div class="text-gray-500 text-base font-normal text-center mb-4">Review your symptoms before getting your diagnosis</div>
          <div id="review-symptom-list" class="w-full flex flex-col gap-4 mb-8"></div>
        </div>
        <div class="flex flex-col gap-3 w-full max-w-xl mx-auto">
          <button id="get-diagnosis" class="w-full bg-[#199A8E] hover:bg-[#157c71] text-white font-semibold rounded-xl py-4 text-base text-center shadow transition">Get My Diagnosis</button>
          <button id="add-symptom" class="w-full bg-white border border-gray-200 text-[#199A8E] font-semibold rounded-xl py-4 text-base text-center shadow transition">+ Add Another Symptom</button>
        </div>
      </div>
    </div>
    <div id="diagnosis-screen" class="fixed inset-0 z-50 bg-gradient-to-br from-blue-50 via-blue-100 to-purple-100 backdrop-blur-xl hidden overflow-y-auto">
      <button id="close-diagnosis" class="absolute top-6 left-6 w-10 h-10 flex items-center justify-center rounded-full bg-[#f1f5f9] text-gray-400 hover:bg-[#e2e8f0] focus:outline-none transition" aria-label="Back">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="w-full min-h-screen flex flex-col justify-start pt-24 pb-12 px-2">
        <main class="w-full max-w-2xl mx-auto p-2 md:p-4 space-y-6">
          <!-- Environmental Assessment Card -->
          <section class="bg-white rounded-2xl shadow p-4 md:p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-2">
              <h2 class="text-lg md:text-xl font-bold text-gray-900">Self-Assessment Detailed Result</h2>
              <button class="bg-[#199A8E] hover:bg-[#157c71] text-white font-medium rounded-lg px-4 py-1.5 flex items-center gap-2 text-sm shadow transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v12m0 0l-4-4m4 4l4-4M4 20h16" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Download Report
              </button>
            </div>
            <div class="flex flex-wrap items-center gap-3 text-gray-500 text-sm mb-4">
              <span class="flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 7V3m8 4V3M3 11h18M5 19h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2z"/></svg> <span id="diagnosis-timestamp">${new Date().toLocaleString()}</span></span>
              <span class="flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17.657 16.657A8 8 0 1 0 7.05 7.05a8 8 0 0 0 10.607 9.607z"/><path d="M15 11a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/></svg> <span id="diagnosis-location">Local Analysis</span></span>
            </div>
            <div class="bg-gradient-to-br from-green-50 via-blue-50 to-white rounded-xl p-4">
              <h3 class="text-base font-semibold text-gray-900 mb-2">Environmental Assessment</h3>
              <div id="environmental-data-container">
                <!-- Environmental data will be populated here dynamically -->
                <div class="text-center py-8">
                  <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#199A8E] mx-auto mb-4"></div>
                  <p class="text-gray-500 text-sm">Loading environmental data...</p>
                </div>
              </div>
            </div>
          </section>
          <!-- Disease Predictions Card -->
          <section class="bg-white rounded-2xl shadow p-4 md:p-6">
            <h3 class="text-base font-semibold text-gray-900 mb-4">Disease Predictions</h3>
            <div class="space-y-3">
              <div class="flex items-center justify-between bg-gradient-to-r from-blue-50 to-white rounded-lg p-4 border border-blue-100">
                <div>
                  <div class="text-base font-bold text-blue-900">Chronic Bronchitis</div>
                  <div class="text-gray-500 text-xs mt-0.5">A long-term inflammation of the bronchial tubes, the airways that carry air to and from the lungs.</div>
                </div>
                <div class="text-xl font-bold text-[#199A8E]">85%</div>
              </div>
              <div class="flex items-center justify-between bg-gray-50 rounded-lg p-4">
                <div>
                  <div class="text-base font-bold text-gray-900">Seasonal Allergies</div>
                  <div class="text-gray-500 text-xs mt-0.5">An allergic response to environmental triggers such as pollen, dust, or mold.</div>
                </div>
                <div class="text-xl font-bold text-gray-400">65%</div>
              </div>
              <div class="flex items-center justify-between bg-gray-50 rounded-lg p-4">
                <div>
                  <div class="text-base font-bold text-gray-900">Common Cold</div>
                  <div class="text-gray-500 text-xs mt-0.5">A viral infectious disease of the upper respiratory tract.</div>
                </div>
                <div class="text-xl font-bold text-gray-400">45%</div>
              </div>
            </div>
          </section>
          <!-- Symptoms Analysis Card -->
          <section class="bg-white rounded-2xl shadow p-4 md:p-6">
            <h3 class="text-base font-semibold text-gray-900 mb-4">Symptoms Analysis</h3>
            <div class="space-y-3">
              <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-base font-bold text-gray-900">Coughing</div>
                <div class="text-gray-500 text-xs mt-0.5">Severity: Moderate &nbsp; Duration: 3 days</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-base font-bold text-gray-900">Shortness of breath</div>
                <div class="text-gray-500 text-xs mt-0.5">Severity: Mild &nbsp; Duration: 2 days</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-base font-bold text-gray-900">Chest pain</div>
                <div class="text-gray-500 text-xs mt-0.5">Severity: Mild &nbsp; Duration: 1 day</div>
              </div>
            </div>
          </section>
          <!-- Important Medical Information Card -->
          <section class="bg-white rounded-2xl shadow p-4 md:p-6">
            <h3 class="text-base font-semibold text-gray-900 mb-4">Important Medical Information</h3>
            
            <!-- Medical Disclaimer -->
            <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
              <h4 class="text-sm font-semibold text-red-800 mb-2">Medical Disclaimer</h4>
              <p class="text-sm text-red-700 leading-relaxed">
                This report is <strong>NOT</strong> a substitute for professional medical advice, diagnosis, or treatment. The information provided is for educational purposes only and should not be used to make medical decisions.
              </p>
            </div>
            
            <!-- General Health Recommendations -->
            <div>
              <h4 class="text-sm font-semibold text-blue-800 mb-3">General Health Recommendations</h4>
              <ul class="space-y-2 text-sm text-gray-700">
                <li class="flex items-start gap-2">
                  <span class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></span>
                  <span>If your symptoms worsen or persist, consult a healthcare professional immediately</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></span>
                  <span>Seek emergency medical care if you experience severe difficulty breathing, chest pain, or other concerning symptoms</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></span>
                  <span>Follow your doctor's advice and complete any prescribed treatments</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></span>
                  <span>Maintain good hygiene practices and avoid close contact with others if you're experiencing symptoms</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></span>
                  <span>Monitor your symptoms and keep a record of any changes or new symptoms</span>
                </li>
              </ul>
            </div>
          </section>
        </main>
        <button id="save-and-return" class="w-full max-w-xs mx-auto mt-4 bg-[#199A8E] hover:bg-[#157c71] text-white font-semibold rounded-xl py-2 text-base text-center shadow transition">Save & Return to Dashboard</button>
      </div>
    </div>
    <div id="warning-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-blue-50 via-blue-100 to-purple-100 backdrop-blur-xl">
      <div class="flex flex-col items-center justify-center w-full max-w-md mx-auto px-4 py-12">
        <div class="flex flex-col items-center">
          <div class="mb-8 mt-2">
            <svg class="w-16 h-16 text-[#199A8E] mx-auto" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 48 48">
              <path d="M24 40s-12-7.333-12-17.333C12 14.667 16.667 12 24 12s12 2.667 12 10.667C36 32.667 24 40 24 40z" stroke="#199A8E" stroke-width="2.5" fill="none"/>
            </svg>
          </div>
          <div class="text-3xl font-normal text-gray-900 mb-6 text-center" style="font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Self-Diagnosis</div>
          <div class="bg-white rounded-2xl shadow-lg p-8 w-full mb-8 flex flex-col items-center" style="box-shadow: 0 4px 24px 0 rgba(0,0,0,0.07);">
            <div class="text-lg text-gray-900 text-center mb-2">This app currently supports diagnosis for <span class="text-[#199A8E] font-medium">respiratory diseases only</span></div>
            <div class="text-gray-700 text-center text-base">We're working on expanding our diagnostic capabilities to serve you better.</div>
          </div>
          <div class="text-center text-base text-red-500 font-normal mb-8">This is not a substitute for professional medical advice.<br/>Always consult with a healthcare provider for proper diagnosis and treatment.</div>
          <button id="continue-warning" class="w-full max-w-xs bg-[#199A8E] hover:bg-[#157c71] text-white font-semibold rounded-xl py-3 text-base text-center shadow transition">Continue</button>
        </div>
      </div>
    </div>
    <script>
      // Symptom list
      const SYMPTOMS = [
        "a dry, crackling sound in the lungs while breathing in",
        "allergy",
        "bluish skin",
        "breath",
        "chest congestion",
        "chest pain",
        "chest tightness",
        "chills",
        "chronic cough",
        "cold",
        "cough",
        "coughing",
        "coughing up blood",
        "coughing up yellow or green mucus daily",
        "daytime sleepiness",
        "diarrhea",
        "difficulties with memory and concentration",
        "distressing",
        "dizziness",
        "dry cough",
        "dry mouth",
        "edema",
        "fainting",
        "faster heart beating",
        "fatigue",
        "feeling run-down or tired",
        "fever",
        "frequently waking",
        "greenish cough",
        "headache",
        "heart palpitations",
        "high fever",
        "irritability",
        "joint pain",
        "loss of appetite",
        "low energy",
        "low fever",
        "lower back pain",
        "morning headaches",
        "mucus",
        "muscle aches",
        "nasal congestion",
        "nausea",
        "night sweats",
        "pain",
        "pauses in breathing",
        "persistent dry cough",
        "rapid breathing",
        "rapid heartbeat",
        "runny nose",
        "shaking",
        "shallow breathing",
        "sharp chest pain",
        "short of breath",
        "short, shallow and rapid breathing",
        "shortness of breath",
        "snoring",
        "sore throat",
        "stuffy nose",
        "sweating",
        "tight feeling in the chest",
        "unusual moodiness",
        "vomiting",
        "weight loss",
        "weight loss from loss of appetite",
        "wheezing",
        "wheezing cough",
        "whistling sound while breathing",
        "whistling sound while you breathe",
        "wider and rounder than normal fingertips and toes",
        "yellow cough"
      ];

      // Follow-up questions mapping
      const FOLLOW_UPS = {
        "shortness of breath": {
          question: "Does your shortness of breath get worse during flare-ups?",
          options: [
            { label: "Yes", value: "Get worse during flare-ups" },
            { label: "No", value: "" }
          ]
        },
        "short of breath": {
          question: "Is your shortness of breath also accompanied by shallow and rapid breath?",
          options: [
            { label: "Yes", value: "Accompanied by shallow and rapid breath?" },
            { label: "No", value: "" }
          ]
        },
        "coughing": {
          question: "Have you had a cough for 3 weeks or longer?",
          options: [
            { label: "Yes", value: "3 weeks or longer" },
            { label: "No", value: "" }
          ]
        },
        "shallow breathing": {
          question: "Is your shallow breathing also accompanied by rapid and short breaths?",
          options: [
            { label: "Yes", value: "Accompanied by rapid and short breaths?" },
            { label: "No", value: "" }
          ]
        },
        "rapid breathing": {
          question: "Is your rapid breathing also accompanied by shallow and short breaths?",
          options: [
            { label: "Yes", value: "Accompanied by shallow and short breaths." },
            { label: "No", value: "" }
          ]
        },
        "chest pain": {
          question: "Is your chest pain sharp or stabbing?",
          options: [
            { label: "Yes", value: "Sharp/Stabbing pain" },
            { label: "No", value: "" }
          ]
        },
        "weight loss": {
          question: "Has your weight loss been accompanied by a loss of appetite?",
          options: [
            { label: "Yes", value: "Accompanied by a loss of appetite" },
            { label: "No", value: "" }
          ]
        },
        "loss of appetite": {
          question: "Has your loss of appetite caused you to lose weight?",
          options: [
            { label: "Yes", value: "Weight loss" },
            { label: "No", value: "" }
          ]
        },
        "fever": {
          question: "How severe is your fever?",
          options: [
            { label: "Low", value: "low fever" },
            { label: "Moderate", value: "moderate fever" },
            { label: "High", value: "high fever" }
          ]
        },
        "sweating": {
          question: "Do you sweat mostly at night?",
          options: [
            { label: "Yes", value: "Night sweating" },
            { label: "No", value: "" }
          ]
        },
        "chest tightness": {
          question: "Does your chest tightness occur during physical activity?",
          options: [
            { label: "Yes", value: "Occurs during physical activity" },
            { label: "No", value: "" }
          ]
        }
      };

      let activeFollowUp = null;
      let followUpAnswer = null;

      let selectedSymptoms = [];

      function filterSymptoms(query) {
        return SYMPTOMS.filter(s => s.toLowerCase().startsWith(query.toLowerCase()) && !selectedSymptoms.includes(s));
      }

      function renderDropdown(matches) {
        // Instead of dropdown, update suggested symptoms
        renderSuggested(matches);
      }

      // Render suggested symptoms (filtered or default)
      function renderSuggested(filteredList = null) {
        const container = document.getElementById('suggested-symptoms-list');
        container.innerHTML = '';
        let list = filteredList;
        if (filteredList && filteredList.length > 0) {
          list = filteredList.slice(0, 5);
        } else {
          // Default suggestions: show up to 5 not-yet-selected symptoms
          list = SYMPTOMS.filter(s => !selectedSymptoms.includes(s)).slice(0, 5);
        }
        list.forEach(symptom => {
          const isSelected = selectedSymptoms.includes(symptom);
          const hasFollowUp = !!FOLLOW_UPS[symptom];
          const item = document.createElement('button');
          item.type = 'button';
          item.className = `w-full text-left px-3 py-2 rounded-lg text-base font-normal mb-1 cursor-pointer transition ${isSelected ? 'bg-[#c7e6e2] text-gray-900' : 'bg-transparent text-gray-900 hover:bg-[#e6f4f1]'}`;
          item.innerHTML = `
            <div class="flex items-center justify-between">
              <span>${symptom}</span>
              ${hasFollowUp ? '<span class="text-xs text-[#199A8E] bg-[#e0f7fa] px-2 py-1 rounded-full">Follow-up</span>' : ''}
            </div>
          `;
          item.onclick = () => selectSymptom(symptom);
          container.appendChild(item);
        });
      }

                    function selectSymptom(symptom) {
        console.log('Selecting symptom:', symptom);
        
        selectedSymptoms.push(symptom);
        console.log('Updated selectedSymptoms:', selectedSymptoms);
        
        document.getElementById('symptom-input').value = '';
        renderSelected();
        renderSuggested();
        
                  // Update progress bar
          document.getElementById('progress-bar').style.width = '50%';
          document.getElementById('step-indicator').textContent = 'Step 2: Review & Diagnose';
        
        // Show follow-up if available
        console.log('Checking follow-up for symptom:', symptom);
        console.log('FOLLOW_UPS keys:', Object.keys(FOLLOW_UPS));
        console.log('Has follow-up:', !!FOLLOW_UPS[symptom]);
        
        if (FOLLOW_UPS[symptom]) {
          console.log('Showing follow-up for:', symptom);
          activeFollowUp = symptom;
          activeFollowUpSymptom = symptom;
          followUpAnswer = null;
          renderFollowUp();
        } else {
          console.log('No follow-up for symptom:', symptom);
          // No follow-up question for this symptom
          activeFollowUp = null;
          activeFollowUpSymptom = null;
          followUpAnswer = null;
          // Show review screen for symptoms without follow-ups
          showReviewScreen();
        }
      }

      function removeSymptom(symptom) {
        selectedSymptoms = selectedSymptoms.filter(s => s !== symptom);
        // Clean up follow-up answer for this symptom
        delete symptomFollowUps[symptom];
        
        renderSelected();
        renderSuggested();
        
        // Update progress bar based on remaining symptoms
        if (selectedSymptoms.length === 0) {
          document.getElementById('progress-bar').style.width = '25%';
          document.getElementById('step-indicator').textContent = 'Step 1: Select Symptoms';
        }
        
        if (activeFollowUp === symptom) {
          activeFollowUp = null;
          followUpAnswer = null;
          renderFollowUp();
        }
      }

      function renderSelected() {
        const container = document.getElementById('selected-symptoms');
        container.innerHTML = '';
        
        console.log('Rendering selected symptoms:', selectedSymptoms);
        
        if (selectedSymptoms.length > 0) {
          container.classList.remove('hidden');
                  selectedSymptoms.forEach(symptom => {
          const tag = document.createElement('button');
          tag.type = 'button';
          tag.className = 'bg-[#c7e6e2] text-gray-800 px-4 py-2 rounded-xl text-base font-medium mr-2 mb-2 shadow-sm transition hover:bg-[#b2dfdb] focus:outline-none';
          
          // Show symptom name and follow-up answer if available
          const followUpAnswer = symptomFollowUps[symptom];
          if (followUpAnswer) {
            tag.innerHTML = `<div class="text-left">${symptom}<br><span class="text-sm text-[#199A8E] font-normal">${followUpAnswer}</span></div>`;
          } else {
            tag.textContent = symptom;
          }
          
          tag.onclick = () => removeSymptom(symptom);
          container.appendChild(tag);
        });
        } else {
          container.classList.add('hidden');
        }
      }

      function renderFollowUp() {
        console.log('renderFollowUp called');
        console.log('activeFollowUp:', activeFollowUp);
        console.log('FOLLOW_UPS[activeFollowUp]:', FOLLOW_UPS[activeFollowUp]);
        
        const overlay = document.getElementById('followup-fullscreen');
        const qDiv = document.getElementById('followup-question');
        const optsDiv = document.getElementById('followup-options');
        
        if (!activeFollowUp || !FOLLOW_UPS[activeFollowUp]) {
          console.log('Hiding overlay - no active follow-up');
          overlay.classList.add('hidden');
          qDiv.textContent = '';
          optsDiv.innerHTML = '';
          return;
        }
        
        console.log('Showing overlay for follow-up');
        const follow = FOLLOW_UPS[activeFollowUp];
        overlay.classList.remove('hidden');
        qDiv.textContent = follow.question;
        optsDiv.innerHTML = '';
        follow.options.forEach(opt => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'border-2 border-[#199A8E] text-[#199A8E] bg-white hover:bg-[#e0f7fa] font-medium rounded-full px-6 py-3 text-base transition focus:outline-none shadow-sm min-w-[120px]';
          btn.textContent = opt.label;
          btn.onclick = () => {
            followUpAnswer = opt.value;
            activeFollowUp = null;
            handleFollowUpAnswer(activeFollowUpSymptom, opt.value);
            renderFollowUp();
          };
          optsDiv.appendChild(btn);
        });
      }

      // Track which symptom is being followed up
      let activeFollowUpSymptom = null;

      // Store follow-up answers per symptom
      let symptomFollowUps = {};

      // When a follow-up is answered, store the answer and show review
      function handleFollowUpAnswer(symptom, answer) {
        if (answer) {
          symptomFollowUps[symptom] = answer;
        } else {
          delete symptomFollowUps[symptom];
        }
        showReviewScreen();
      }

      function showReviewScreen() {
        console.log('Showing review screen with symptoms:', selectedSymptoms);
        
        // Update progress bar to show we're in review stage
        document.getElementById('progress-bar').style.width = '75%';
        document.getElementById('step-indicator').textContent = 'Step 2: Review & Diagnose';
        
        const overlay = document.getElementById('review-screen');
        const countDiv = document.getElementById('review-symptom-count');
        const listDiv = document.getElementById('review-symptom-list');
        overlay.classList.remove('hidden');
        countDiv.textContent = `${selectedSymptoms.length} Symptom${selectedSymptoms.length > 1 ? 's' : ''} Recorded`;
        listDiv.innerHTML = '';
        selectedSymptoms.forEach(symptom => {
          const card = document.createElement('div');
          card.className = 'w-full bg-white/90 rounded-xl border border-gray-200 flex items-center justify-between px-6 py-4';
          const left = document.createElement('div');
          left.className = 'flex flex-col';
          const label = document.createElement('div');
          label.className = 'text-lg font-semibold text-gray-900';
          label.textContent = symptom;
          left.appendChild(label);
          // Show follow-up answer if present
          if (symptomFollowUps[symptom]) {
            const pill = document.createElement('div');
            pill.className = 'inline-block bg-[#c7e6e2] text-[#199A8E] px-3 py-1.5 rounded-xl text-sm font-normal mt-2 break-words whitespace-normal w-full';
            pill.textContent = symptomFollowUps[symptom];
            left.appendChild(pill);
          }
          card.appendChild(left);
          // Remove button
          const removeBtn = document.createElement('button');
          removeBtn.className = 'text-gray-400 hover:text-red-500 text-2xl font-bold ml-4 focus:outline-none';
          removeBtn.innerHTML = '&times;';
          removeBtn.onclick = () => {
            removeSymptom(symptom);
            showReviewScreen();
          };
          card.appendChild(removeBtn);
          listDiv.appendChild(card);
        });
        setTimeout(attachReviewOverlayListeners, 0); // Ensure listeners are always attached after DOM update
      }

      function attachReviewOverlayListeners() {
        const addSymptomBtn = document.getElementById('add-symptom');
        const getDiagnosisBtn = document.getElementById('get-diagnosis');
        if (addSymptomBtn) {
          addSymptomBtn.onclick = () => {
            document.getElementById('review-screen').classList.add('hidden');
            // Reset progress bar to symptoms selection
            document.getElementById('progress-bar').style.width = '50%';
            document.getElementById('step-indicator').textContent = 'Step 2: Review & Diagnose';
          };
        }
        if (getDiagnosisBtn) {
          getDiagnosisBtn.onclick = async () => {
            document.getElementById('review-screen').classList.add('hidden');
            const diag = document.getElementById('diagnosis-screen');
            diag.classList.remove('hidden');
            diag.style.removeProperty('display');
            diag.style.removeProperty('visibility');
            diag.style.removeProperty('opacity');
            diag.style.position = 'fixed';
            diag.style.inset = '0';
            diag.style.zIndex = '9999';
            // Hide main input area
            document.getElementById('input-main').style.display = 'none';
            
            // Populate environmental data for the diagnosis report
            populateEnvironmentalData();

            // Update progress bar to 100%
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('step-indicator').textContent = 'Step 3: Results';
            
            // Show loading state with selected symptoms
            const diseaseCard = diag.querySelector('section:nth-of-type(2)');
            diseaseCard.innerHTML = `
              <div class="flex flex-col items-center justify-center h-32 space-y-3">
                <div class="flex items-center gap-2">
                  <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-[#199A8E]"></div>
                  <span class="text-gray-400 text-lg">Analyzing symptoms...</span>
                </div>
                <div class="text-sm text-gray-500 text-center">
                  Processing: ${selectedSymptoms.join(', ')}
                </div>
              </div>
            `;

            // Get personal information from localStorage
            let age, sex;
            try {
              const personal = JSON.parse(localStorage.getItem('personalDetails') || '{}');
              age = personal.dob ? calculateAge(personal.dob) : null;
              sex = personal.sex ? personal.sex.toLowerCase() : null;
              
              if (!age || !sex) {
                diseaseCard.innerHTML = '<div class="text-red-500 text-center py-8">Personal information incomplete. Please complete your profile first.</div>';
                return;
              }
            } catch (e) {
              diseaseCard.innerHTML = '<div class="text-red-500 text-center py-8">Error loading personal information. Please refresh the page.</div>';
              return;
            }
            
            // Prepare input for API
            const symptoms = selectedSymptoms.join(', '); // Combine all symptoms into one string
            
            console.log('Selected symptoms:', selectedSymptoms);
            console.log('Symptoms string:', symptoms);
            console.log('Age:', age);
            console.log('Sex:', sex);
            
            if (selectedSymptoms.length === 0) {
              diseaseCard.innerHTML = '<div class="text-red-500 text-center py-8">No symptoms selected. Please select at least one symptom.</div>';
              return;
            }
            
            try {
              console.log('Sending request to backend:', { symptoms, age, sex });
              
              // Check if we're running from file:// protocol
              const isFileProtocol = window.location.protocol === 'file:';
              if (isFileProtocol) {
                console.warn('Running from file:// protocol - this may cause CORS issues');
              }
              
              const response = await fetch('http://localhost:5001/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symptoms: symptoms, age: age, sex: sex })
              });
              
              console.log('Response status:', response.status);
              console.log('Response headers:', response.headers);
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error('Response not OK:', response.status, errorText);
                throw new Error(`API error: ${response.status} ${errorText}`);
              }
              
              const data = await response.json();
              console.log('Response data:', data);
              
              if (!Array.isArray(data) || data.length === 0) {
                throw new Error('Invalid response format from API');
              }
              
              // Show results in Disease Predictions card
              let predictionsHTML = '<h3 class="text-base font-semibold text-gray-900 mb-4">Disease Predictions</h3><div class="space-y-3">';
              
              data.forEach((prediction, index) => {
                const isTop = index === 0;
                const bgClass = isTop ? 'bg-gradient-to-r from-blue-50 to-white border border-blue-100' : 'bg-gray-50';
                const textClass = isTop ? 'text-blue-900' : 'text-gray-900';
                const probClass = isTop ? 'text-[#199A8E]' : 'text-gray-400';
                
                // Cap probability at 90% and show medical guidance for high confidence
                let displayProbability = prediction.probability;
                let medicalGuidance = '';
                
                if (prediction.probability > 0.9) {
                  displayProbability = 0.9; // Cap at 90%
                  medicalGuidance = '<div class="text-red-600 text-xs mt-1 font-medium">‚ö†Ô∏è See medical professional as soon as possible</div>';
                }
                
                predictionsHTML += `
                  <div class="flex items-center justify-between ${bgClass} rounded-lg p-4">
                    <div>
                      <div class="text-base font-bold ${textClass}">${prediction.disease}</div>
                      <div class="text-gray-500 text-xs mt-0.5">Probability: ${(displayProbability * 100).toFixed(1)}%</div>
                      ${medicalGuidance}
                    </div>
                    <div class="text-xl font-bold ${probClass}">${(displayProbability * 100).toFixed(1)}%</div>
                  </div>
                `;
              });
              
              predictionsHTML += '</div>';
              diseaseCard.innerHTML = predictionsHTML;
              
              // Add a summary section
              const topPrediction = data[0];
              const displayProbability = Math.min(topPrediction.probability, 0.9); // Cap at 90%
              const medicalGuidance = topPrediction.probability > 0.9 ? '‚ö†Ô∏è See medical professional as soon as possible' : 
                (topPrediction.probability > 0.5 ? 'Consider consulting a healthcare provider' : 'Monitor symptoms and seek care if they worsen');
              
              const summaryHTML = `
                <div class="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
                  <h4 class="font-medium text-blue-900 mb-2">Summary</h4>
                  <div class="text-sm text-blue-800 space-y-1">
                    <div>‚Ä¢ <strong>Primary concern:</strong> ${topPrediction.disease} (${(displayProbability * 100).toFixed(1)}% probability)</div>
                    <div>‚Ä¢ <strong>Symptoms analyzed:</strong> ${selectedSymptoms.length} respiratory symptoms</div>
                    <div>‚Ä¢ <strong>Recommendation:</strong> ${medicalGuidance}</div>
                  </div>
                </div>
              `;
              diseaseCard.innerHTML += summaryHTML;
              
              // Update the Symptoms Analysis section
              const symptomsAnalysisCard = diag.querySelector('section:nth-of-type(3)');
              if (symptomsAnalysisCard) {
                let symptomsHTML = '<h3 class="text-base font-semibold text-gray-900 mb-4">Symptoms Analysis</h3><div class="space-y-3">';
                
                selectedSymptoms.forEach((symptom, index) => {
                  const followUpAnswer = symptomFollowUps[symptom];
                  
                  symptomsHTML += `
                    <div class="bg-gray-50 rounded-lg p-4">
                      <div class="text-base font-bold text-gray-900">${symptom}</div>
                      ${followUpAnswer ? `<div class="text-gray-500 text-xs mt-0.5">${followUpAnswer}</div>` : ''}
                    </div>
                  `;
                });
                
                symptomsHTML += '</div>';
                symptomsAnalysisCard.innerHTML = symptomsHTML;
              }
              
                       // Update the Important Medical Information section (no longer dynamic)
         const medicalInfoCard = diag.querySelector('section:nth-of-type(4)');
         if (medicalInfoCard) {
           // Keep the static medical information - no dynamic updates needed
           // The card already contains the proper medical disclaimer and recommendations
         }
              
                        // Store the report data for the save button
          window.currentReportData = {
            predictions: data,
            symptoms: selectedSymptoms,
            followUpAnswers: symptomFollowUps
          };
          
          console.log('Report data stored in window.currentReportData:', window.currentReportData);
          
          // Store the report data for later saving (don't save automatically)
          // Report will be saved when user clicks "Save & Return" button
          console.log('Report data prepared for saving (will be saved when user clicks Save & Return)');
              
            } catch (err) {
              console.error('API Error:', err);
              
              let errorMessage = `Could not get diagnosis: ${err.message}`;
              
              // Add helpful guidance for common issues
              if (window.location.protocol === 'file:') {
                errorMessage += '<br><br><strong>üí° Tip:</strong> Open this page from <code>http://localhost:8000/selfdiagnosis.html</code> instead of opening the file directly.';
              }
              
              diseaseCard.innerHTML = `<div class="text-red-500 text-center py-8">${errorMessage}</div>`;
            }
          };
        }
      }

      window.addEventListener('DOMContentLoaded', () => {
        // Check personal information and redirect if needed
        function checkPersonalInfo() {
          try {
            const personal = JSON.parse(localStorage.getItem('personalDetails') || '{}');
            
            if (personal.dob && personal.sex) {
              // Personal info is complete, ready for symptoms
              document.getElementById('progress-bar').style.width = '25%';
              document.getElementById('step-indicator').textContent = 'Step 1: Select Symptoms';
            } else {
              // Redirect to personal details if information is missing
              window.location.href = 'personaldetails.html?redirect=selfdiagnosis';
            }
          } catch (e) {
            console.error('Error checking personal info:', e);
            // Redirect to personal details if there's an error
            window.location.href = 'personaldetails.html?redirect=selfdiagnosis';
          }
        }
        
        // Check personal information on page load
        checkPersonalInfo();
        
        const input = document.getElementById('symptom-input');
        input.addEventListener('input', (e) => {
          const matches = filterSymptoms(e.target.value);
          renderSuggested(matches);
        });
        input.addEventListener('focus', (e) => {
          const matches = filterSymptoms(e.target.value);
          renderSuggested(matches);
        });
        document.addEventListener('click', (e) => {
          // No dropdown to hide
        });
        renderFollowUp();
        renderSuggested();
        document.getElementById('close-followup').onclick = () => {
          document.getElementById('followup-fullscreen').classList.add('hidden');
          activeFollowUp = null;
          followUpAnswer = null;
        };
        document.getElementById('close-review').onclick = () => {
          document.getElementById('review-screen').classList.add('hidden');
        };
        document.getElementById('close-diagnosis').onclick = () => {
          document.getElementById('diagnosis-screen').classList.add('hidden');
          // Show main input area again
          document.getElementById('input-main').style.display = '';
          // Reset progress bar to symptoms selection
          document.getElementById('progress-bar').style.width = '50%';
          document.getElementById('step-indicator').textContent = 'Step 2: Review & Diagnose';
        };
        attachReviewOverlayListeners();
      });
      
      // Helper function to calculate age from date of birth
      function calculateAge(dob) {
        const birth = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
          age--;
        }
        return age;
      }
      

      

      
      // Function to populate environmental assessment data
      async function populateEnvironmentalData() {
        try {
          const container = document.getElementById('environmental-data-container');
          if (!container) return;
          
          // Get current AQI and location data from localStorage
          const aqiData = JSON.parse(localStorage.getItem('aqiData') || '{}');
          const userLocation = JSON.parse(localStorage.getItem('userLocation') || '{}');
          
          if (!aqiData.value && !aqiData.city && !userLocation.city) {
            // No environmental data available
            container.innerHTML = `
              <div class="text-center py-6">
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                  <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M17.657 16.657A8 8 0 1 0 7.05 7.05a8 8 0 0 0 10.607 9.607z"/>
                    <path d="M15 11a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                  </svg>
                </div>
                <p class="text-gray-500 text-sm mb-2">Location not set</p>
                <p class="text-gray-400 text-xs">Set your location in the AQI card to see environmental data</p>
              </div>
            `;
            return;
          }
          
          // Fetch fresh weather data if we have coordinates or city
          let weatherData = null;
          let coordinates = null;
          
          // First try to get coordinates from AQI data
          if (aqiData.lat && aqiData.lon) {
            coordinates = { lat: aqiData.lat, lon: aqiData.lon };
            console.log('Using coordinates from AQI data:', coordinates);
          } else if (aqiData.city) {
            // If no coordinates but we have city, try to get coordinates first
            try {
              console.log('Getting coordinates for city:', aqiData.city);
              const geoResponse = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(aqiData.city)}&limit=1&appid=71335327a6465f6e51613d7670f2f7aa`);
              if (geoResponse.ok) {
                const geoData = await geoResponse.json();
                if (geoData.length > 0) {
                  coordinates = { lat: geoData[0].lat, lon: geoData[0].lon };
                  console.log('Got coordinates for city:', coordinates);
                }
              }
            } catch (error) {
              console.error('Error getting coordinates for city:', error);
            }
          }
          
          // Now fetch weather data if we have coordinates using IQAir
          if (coordinates) {
            try {
              console.log('Fetching weather data for coordinates using IQAir:', coordinates);
              const weatherResponse = await fetch(`http://api.airvisual.com/v2/nearest_city?lat=${coordinates.lat}&lon=${coordinates.lon}&key=ed2a35ef-6af9-4905-810d-47875737716d`);
              if (weatherResponse.ok) {
                const iqairData = await weatherResponse.json();
                if (iqairData.status === 'success') {
                  weatherData = {
                    main: {
                      temp: iqairData.data.current.weather.tp,
                      humidity: iqairData.data.current.weather.hu
                    }
                  };
                  console.log('IQAir weather data fetched successfully:', weatherData);
                }
              }
            } catch (error) {
              console.error('Error fetching weather data from IQAir:', error);
            }
          } else {
            console.log('No coordinates available for weather data fetch');
          }
          
          // Determine location display
          const locationDisplay = aqiData.city || userLocation.city || 'Local Analysis';
          
          // Get AQI level and color
          const aqiValue = aqiData.value || 'N/A';
          const aqiLevel = aqiData.level || getAQILevel(aqiValue);
          const aqiColor = getAQIColor(aqiLevel);
          const aqiDescription = getAQIDescription(aqiValue);
          
          // Debug: Log what data we have
          console.log('Environmental data debug:', {
            aqiData: aqiData,
            userLocation: userLocation,
            coordinates: coordinates,
            weatherData: weatherData
          });
          
          // Populate the container
          container.innerHTML = `
            <div class="mb-4">
              <span class="inline-block ${aqiColor.bg} ${aqiColor.text} font-semibold rounded-full px-3 py-0.5 text-sm mb-2">
                AQI: ${aqiValue} (${aqiLevel})
              </span>
              <p class="text-gray-600 text-sm">${aqiDescription}</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="bg-white rounded-lg shadow p-3">
                <div class="text-gray-400 text-xs mb-0.5">Location</div>
                <div class="text-base font-bold text-gray-900">${locationDisplay}</div>
              </div>
              <div class="bg-white rounded-lg shadow p-3">
                <div class="text-gray-400 text-xs mb-0.5">Temperature</div>
                <div class="text-base font-bold text-gray-900">${weatherData ? Math.round(weatherData.main.temp) + '¬∞C' : 'N/A'}</div>
              </div>
              <div class="bg-white rounded-lg shadow p-3">
                <div class="text-gray-400 text-xs mb-0.5">Humidity</div>
                <div class="text-base font-bold text-gray-900">${weatherData ? weatherData.main.humidity + '%' : 'N/A'}</div>
              </div>
              <div class="bg-white rounded-lg shadow p-3">
                <div class="text-gray-400 text-xs mb-0.5">Air Quality</div>
                <div class="text-base font-bold text-gray-900">${aqiLevel}</div>
              </div>
            </div>

          `;
          
          // Add event listener for refresh button
          const refreshBtn = document.getElementById('refresh-env-data');
          if (refreshBtn) {
            refreshBtn.addEventListener('click', async () => {
              console.log('Refresh button clicked - fetching fresh environmental data');
              await populateEnvironmentalData();
            });
          }
          
          // Update timestamp and location in the header
          const timestampElement = document.getElementById('diagnosis-timestamp');
          const locationElement = document.getElementById('diagnosis-location');
          
          if (timestampElement) {
            timestampElement.textContent = new Date().toLocaleString();
          }
          
          if (locationElement) {
            locationElement.textContent = locationDisplay;
          }
          
        } catch (error) {
          console.error('Error populating environmental data:', error);
          const container = document.getElementById('environmental-data-container');
          if (container) {
            container.innerHTML = `
              <div class="text-center py-6">
                <p class="text-red-500 text-sm">Error loading environmental data</p>
              </div>
            `;
          }
        }
      }
      
      // Helper function to get AQI level
      function getAQILevel(aqi) {
        if (aqi <= 50) return 'Good';
        if (aqi <= 100) return 'Moderate';
        if (aqi <= 150) return 'Unhealthy for Sensitive Groups';
        if (aqi <= 200) return 'Unhealthy';
        if (aqi <= 300) return 'Very Unhealthy';
        return 'Hazardous';
      }
      
      // Helper function to get AQI color
      function getAQIColor(level) {
        const colors = {
          'Good': { bg: 'bg-green-100', text: 'text-green-700' },
          'Moderate': { bg: 'bg-yellow-100', text: 'text-yellow-700' },
          'Unhealthy for Sensitive Groups': { bg: 'bg-orange-100', text: 'text-orange-700' },
          'Unhealthy': { bg: 'bg-red-100', text: 'text-red-700' },
          'Very Unhealthy': { bg: 'bg-purple-100', text: 'text-purple-700' },
          'Hazardous': { bg: 'bg-red-800', text: 'text-white' }
        };
        return colors[level] || colors['Good'];
      }
      
      // Helper function to get AQI description
      function getAQIDescription(aqi) {
        if (aqi <= 50) return 'Air quality is considered satisfactory, and air pollution poses little or no risk.';
        if (aqi <= 100) return 'Air quality is acceptable; however, some pollutants may be a concern for a small number of people.';
        if (aqi <= 150) return 'Members of sensitive groups may experience health effects.';
        if (aqi <= 200) return 'Some members of the general public may experience health effects.';
        if (aqi <= 300) return 'Health alert: everyone may experience health effects.';
        return 'Health warning: everyone may experience serious health effects.';
      }
      
      // Helper function to get weather type from temperature
      function getWeatherType(temperature) {
        if (temperature < 0) return 'Snow';
        if (temperature < 10) return 'Cold';
        if (temperature < 20) return 'Cool';
        if (temperature < 25) return 'Mild';
        if (temperature < 30) return 'Warm';
        return 'Hot';
      }
      
      // Helper function to get weather description from temperature and humidity
      function getWeatherDescription(temperature, humidity) {
        const tempDesc = getWeatherType(temperature);
        if (humidity > 80) return `${tempDesc} and Humid`;
        if (humidity < 30) return `${tempDesc} and Dry`;
        return tempDesc;
      }
      
      // Function to save completed report to localStorage
      async function saveReportToHistory(predictions, symptoms, followUpAnswers) {
        try {
          console.log('saveReportToHistory called with:', { predictions, symptoms, followUpAnswers });
          
          // Get current AQI data from localStorage (reuse existing AQI)
          const aqiData = JSON.parse(localStorage.getItem('aqiData') || '{}');
          const userLocation = JSON.parse(localStorage.getItem('userLocation') || '{}');
          
          console.log('Available data for saving:', { aqiData, userLocation });
          
          // Fetch fresh weather data for the report
          let freshWeatherData = null;
          let coordinates = null;
          
          // First try to get coordinates from AQI data
          if (aqiData.lat && aqiData.lon) {
            coordinates = { lat: aqiData.lat, lon: aqiData.lon };
            console.log('Using coordinates from AQI data for report:', coordinates);
          } else if (aqiData.city) {
            // If no coordinates but we have city, try to get coordinates first
            try {
              console.log('Getting coordinates for city in report:', aqiData.city);
              const geoResponse = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(aqiData.city)}&limit=1&appid=71335327a6465f6e51613d7670f2f7aa`);
              if (geoResponse.ok) {
                const geoData = await geoResponse.json();
                if (geoData.length > 0) {
                  coordinates = { lat: geoData[0].lat, lon: geoData[0].lon };
                  console.log('Got coordinates for city in report:', coordinates);
                }
              }
            } catch (error) {
              console.error('Error getting coordinates for city in report:', error);
            }
          }
          
          // Now fetch weather data if we have coordinates using IQAir
          if (coordinates) {
            try {
              console.log('Fetching weather data for report coordinates using IQAir:', coordinates);
              const weatherResponse = await fetch(`http://api.airvisual.com/v2/nearest_city?lat=${coordinates.lat}&lon=${coordinates.lon}&key=ed2a35ef-6af9-4905-810d-47875737716d`);
              if (weatherResponse.ok) {
                const iqairData = await weatherResponse.json();
                if (iqairData.status === 'success') {
                  freshWeatherData = {
                    temperature: Math.round(iqairData.data.current.weather.tp),
                    humidity: iqairData.data.current.weather.hu,
                    description: getWeatherDescription(iqairData.data.current.weather.tp, iqairData.data.current.weather.hu)
                  };
                  console.log('Fresh IQAir weather data fetched for report:', freshWeatherData);
                }
              }
            } catch (error) {
              console.error('Error fetching fresh weather data from IQAir for report:', error);
            }
          } else {
            console.log('No coordinates available for weather data fetch in report');
          }
          
          const report = {
            id: Date.now(), // Unique identifier
            timestamp: new Date().toISOString(),
            date: new Date().toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric', 
              year: 'numeric' 
            }),
            time: new Date().toLocaleTimeString('en-US', { 
              hour: 'numeric', 
              minute: '2-digit',
              hour12: true 
            }),
            symptoms: symptoms.map(symptom => ({
              name: symptom,
              detail: followUpAnswers[symptom] || null
            })),
            predictions: predictions.map(pred => ({
              disease: pred.disease,
              probability: pred.probability
            })),
            topPrediction: {
              disease: predictions[0].disease,
              probability: predictions[0].probability
            },
            // Include environmental data: AQI from stored state, fresh weather data
            environmentalData: {
              aqi: aqiData.value || null,
              aqiLevel: aqiData.level || null,
              temperature: freshWeatherData ? freshWeatherData.temperature : null,
              humidity: freshWeatherData ? freshWeatherData.humidity : null,
              location: aqiData.city || userLocation.city || null
            }
          };
          
          console.log('Environmental data being saved:', {
            aqi: aqiData.value,
            aqiLevel: aqiData.level,
            temperature: freshWeatherData ? freshWeatherData.temperature : null,
            humidity: freshWeatherData ? freshWeatherData.humidity : null,
            location: aqiData.city || userLocation.city
          });
          
          // Get existing reports or create new array
          const existingReports = JSON.parse(localStorage.getItem('symptomReports') || '[]');
          
          // Add new report to the beginning (most recent first)
          existingReports.unshift(report);
          
          // Keep only the last 10 reports to prevent localStorage from getting too large
          if (existingReports.length > 10) {
            existingReports.splice(10);
          }
          
          // Save back to localStorage
          localStorage.setItem('symptomReports', JSON.stringify(existingReports));
          
          console.log('Report saved successfully with environmental data:', report);
          
        } catch (error) {
          console.error('Error saving report:', error);
        }
      }

      // Save & Return button logic
      document.addEventListener('DOMContentLoaded', function() {
        var saveBtn = document.getElementById('save-and-return');
        if (saveBtn) {
          saveBtn.onclick = async function() {
            try {
              console.log('Save button clicked');
              
              // Save the current report to history
              if (window.currentReportData) {
                console.log('Saving report with data:', window.currentReportData);
                await saveReportToHistory(
                  window.currentReportData.predictions,
                  window.currentReportData.symptoms,
                  window.currentReportData.followUpAnswers
                );
                console.log('Report saved successfully');
              } else {
                console.error('No current report data available for saving');
                alert('No report data available to save. Please try the assessment again.');
                return;
              }
              
              // Redirect to dashboard
              window.location.href = 'index.html';
            } catch (error) {
              console.error('Error saving report:', error);
              alert('Error saving report. Please try again.');
            }
          };
        }
      });

      // Show warning overlay only if navigated from Start Self-Assessment (with ?start=1)
      document.addEventListener('DOMContentLoaded', function() {
        var warning = document.getElementById('warning-overlay');
        var cont = document.getElementById('continue-warning');
        var params = new URLSearchParams(window.location.search);
        var shouldShow = params.get('start') === '1' && !sessionStorage.getItem('selfdiag_warning_dismissed');
        if (warning && cont) {
          if (shouldShow) {
            warning.style.display = '';
          } else {
            warning.style.display = 'none';
          }
          cont.onclick = function() {
            warning.style.display = 'none';
            sessionStorage.setItem('selfdiag_warning_dismissed', '1');
          };
        }
      });
    </script>
  </body>
</html> 